---
layout: page
title: 데이터 시각화
subtitle: "R 시각화 색상(color)"
author:
    name: xwMOOC
    url: https://www.facebook.com/groups/tidyverse/
    affiliation: Tidyverse Korea
date: "`r Sys.Date()`"
output:
  html_document: 
    toc: yes
    toc_float: true
    highlight: tango
    code_folding: show
    number_section: true
    self_contained: true
editor_options: 
  chunk_output_type: console
---

```{r  include = FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE,
                    comment="", digits = 3, tidy = FALSE, prompt = FALSE, fig.align = 'center')

library(tidyverse)
library(scales)
library(showtext) # 글꼴, install.packages("showtext")
library(extrafont)
loadfonts()
```

# 데이터 픽셀 비율 [^data-to-pixel-ratio] [^bbc-style] [^bbc-rcookbook] {#data-pixel-ratio}

[^data-to-pixel-ratio]: [Peter Prevos (February 24, 2019), "Strategic Data Science: Creating Value With Data Big and Small", The Lucid Manager](https://lucidmanager.org/strategic-data-science/)

[^bbc-style]: [BBC - `bbplot`](https://github.com/bbc/bbplot)

[]: ["BBC Visual and Data Journalism cookbook for R graphics"](https://bbc.github.io/rcookbook/)

시각화의 중요한 원칙중의 하나는 화면 전체 픽셀(pixel)과 정보를 표현하는 픽셀 비율을 
최대화하는 것이다. 흔히 데이터와 픽셀 비율(data to pixel ratio)로 계량화하는데 
데이터-픽셀 비율이 낮는 경와 데이터-픽셀 비율이 높은 경우를 다음 사례를 통해 쉽게 파악할 수 있다.

<img src="fig/data-to-pixel-ratio.png" alt="데이터와 픽셀 비율" width="100%" />

# 강조(하이라이트) [^anatomy-gghighlight] {#gghighlight}

[^anatomy-gghighlight]: [Hiroaki Yutani (June 3, 2018), "Anatomy of gghighlight"](https://yutani.rbind.io/post/2018-06-03-anatomy-of-gghighlight/)

[`gghighlight`](https://github.com/yutannihilation/gghighlight) 팩키지를 통해 직접 특정부분을 강조하는 시각화 산출물을 작성해도 좋지만, ["Anatomy of gghighlight"](https://yutani.rbind.io/post/2018-06-03-anatomy-of-gghighlight/) 블로그 내용을 바탕으로 강조(하이라이트)하는 원칙을 살펴보자.

## 강조(하이라이트) 원리 [^ggplot-background] {#gghighlight-anatomy}

[^ggplot-background]: [BLOGR (2016), "Plotting background data for groups with ggplot2"](https://drsimonj.svbtle.com/plotting-background-data-for-groups-with-ggplot2)

붓꽃 `iris` 데이터를 배경을 깔고 종별로 히스토그램을 비교하는 시각화 산출물을 작성해 보자.

이를 위해서 먼저 `iris_bg` 데이터프레임을 하나 제작하고 `Sepal.Width` 변수로 히스토그램을 작성한다. 
`iris_bg` 배경 데이터프레임으로 히스토그램을 만들고 `facet_warp()` 함수로 종별로 히스토그램을 완성시킨다. 원리는 `geom_histogram()` 첫번째 히스토그램은 `iris_bg` 데이터프레임을 활용하여 종족이 없는 `Sepal.Width` 전체 종에 대한 히스토그램을 만들고, 두번째 히스토그램은 디폴트 설정된 색이 반영된 `iris` 데이터프레임에 대한 색상을 얻게된 히스토그램이 제작된다. 마지막으로 `facet_wrap()`으로 붓꽃 종별로 히스토그램이 나뉘어서 시각화된다.

```{r gghighlight-anatomy-iris}
library(tidyverse)

iris_bg <- iris[, -5]  # Background Data - full without the 5th column (Species)

ggplot(iris, aes(x = Sepal.Width)) +
  geom_histogram(data = iris_bg, fill = "grey") +
  geom_histogram() +
  facet_wrap(~ Species)
```

색상도 각 붓꽃 종별로 넣고 보기좋게 작업한 코드는 다음과 같다.

```{r gghighlight-anatomy-iris-color}
ggplot(iris, aes(x = Sepal.Width, fill = Species)) +
  geom_histogram(data = iris_bg, fill = "grey", alpha = .5) +
  geom_histogram(colour = "black") +
  facet_wrap(~ Species) +
  guides(fill = FALSE) +  # to remove the legend
  theme_bw()              # for clean look overall
```

`gghighlight` 팩키지를 활용하여 붓꽃 종별로 강조 하이라이트를 수월히 할 수 있다.


```{r gghiglight-package-iris}
library(gghighlight)

species_g <- ggplot(iris, aes(Sepal.Length, fill = Species)) +
  geom_histogram() +
  theme(legend.position = "top")

species_highlight_g <- ggplot(iris, aes(Sepal.Length, fill = Species)) +
  geom_histogram() +
  gghighlight() +
  facet_wrap(~ Species)

cowplot::plot_grid(species_g, species_highlight_g)
```

# 강조(하이라이트) 사례 {#gghighlight-case-study}

## 막대그래프 강조(하이라이트) {#gghighlight-barplot}

### 막대그래프 색상 {#gghighlight-barplot-ifelse}

`geom_bar()` 함수에 `fill=` 인자를 `if_else()`와 결합하여 색상을 달리 차별화 시킨다.

```{r gghighlight-point}
library(bbplot)
library(tidyverse)
library(gapminder)
library(extrafont)
loadfonts()

top_five_df <- gapminder %>%
  filter(year == 2007 & continent == "Africa") %>%
  top_n(5, wt=lifeExp)

top_five_df %>% 
  ggplot(aes(x = fct_reorder(country, lifeExp), y = lifeExp)) +
  geom_bar(stat="identity", position="identity", 
           fill=if_else(top_five_df$country == "Tunisia", "#1380A1", "#dddddd")) +
  geom_hline(yintercept = 0, size = 1, colour="#333333") +
  theme_minimal(base_family="NanumGothic") +
  coord_flip() +
  labs(title="레위니옹(Reunion)이 장수국가",
       subtitle = "아프리카 2007년 기대수명 상위국가") +
  theme(panel.grid.major.x = element_line(color="#cbcbcb"), 
        panel.grid.major.y=element_blank()) +
  labs(x="", y="기대수명")
```

### 막대그래프 + 라벨 {#gghighlight-barplot-label}

`geom_label()` 함수에 `aes()` 함수 내부에 `label=` 인자를 넣어 라벨을 붙일 수 있고, 
라벨 색상을 `color=` 인자에 `if_else()`를 조합시켜 강조하여 가시성을 높인다.

```{r gghighlight-barplot-highlight}
top_five_df <- gapminder %>%
  filter(year == 2007 & continent == "Africa") %>%
  top_n(5, wt=lifeExp)

top_five_df %>% 
  ggplot(aes(x = fct_reorder(country, lifeExp), y = lifeExp)) +
  geom_bar(stat="identity", position="identity", 
           fill=if_else(top_five_df$country == "Tunisia", "#1380A1", "#dddddd")) +
  geom_hline(yintercept = 0, size = 1, colour="#333333") +
  theme_minimal(base_family="NanumGothic") +
  coord_flip() +
  labs(title="레위니옹(Reunion)이 장수국가",
       subtitle = "아프리카 2007년 기대수명 상위국가") +
  theme(panel.grid.major.x = element_line(color="#cbcbcb"), 
        panel.grid.major.y=element_blank()) +
  labs(x="", y="기대수명") +
  geom_label(aes(x = country, 
                 y = lifeExp - 6, 
                 label = round(lifeExp, 0)), 
             hjust = 0, 
             vjust = 0.5, 
             colour = if_else(top_five_df$country == "Tunisia", "red", "#dddddd"), 
             fill = NA, 
             label.size = NA,
             family="Nanum Pen Script", 
             size = 10)
```

## 선그래프 강조(하이라이트) {#gghighlight-lineplot}

### 선그래프 색상 {#gghighlight-lineplot-ifelse}

`geom_line()` 선그래프 색상을 `scale_colour_manual()` 함수에 `value=` 인자를 달리하여 차별화할 수 있다. 

```{r gghighlight-asia-line-colour}
oceania_df <- gapminder %>%
  filter(continent == "Oceania") 

oceania_df %>% 
  ggplot(aes(x = year, y = lifeExp, colour = country)) +
    geom_line(size = 1) +
    scale_colour_manual(values = c("#FAAB18", "#dddddd")) +
    theme_minimal(base_family = "NanumGothic") +
    labs(title="호주가 장수국가",
         subtitle = "호주와 뉴질랜드 기대수명 비교") +
    theme(legend.position = "top") +
    labs(x="", y="기대수명") 
```


### 선그래프 색상 + 라벨 {#gghighlight-lineplot-ifelse-label}

또한, `geom_label()`과 `geom_curve()`를 사용하여 특정 지점에 화살표를 넣어 라벨을 붙여 강조하는 것도 가능하다.

```{r gghighlight-asia}
oceania_df <- gapminder %>%
  filter(continent == "Oceania") 

oceania_df %>% 
  ggplot(aes(x = year, y = lifeExp, colour = country)) +
    geom_line(size = 1) +
    scale_colour_manual(values = c("#FAAB18", "#dddddd")) +
    theme_minimal(base_family = "NanumGothic") +
    labs(title="호주가 장수국가",
         subtitle = "호주와 뉴질랜드 기대수명 비교") +
    theme(legend.position = "top") +
    labs(x="", y="기대수명") +
    geom_label(aes(x = 1990, y = 73, label = "호주 \n 장수국가!!!"), 
             hjust = 0, 
             vjust = 0.5, 
             lineheight = 0.8,
             colour = "#FAAB18", 
             fill = "white", 
             label.size = NA, 
             family="Nanum Pen Script", 
             size = 6) + 
     geom_curve(aes(x = 1990, y = 73, xend = 1975, yend = 72), 
                   colour = "#555555", 
                   curvature = -0.3,
                   size=0.7,
                   arrow = arrow(length = unit(0.05, "npc")))
```


## 히스토그램 강조(하이라이트) {#gghighlight-histogram}

### 단변량 히스토그램 {#gghighlight-histogram-ifelse}

변수를 하나 뽑아 `geom_histogram()`을 작성한다. `geom_density()`와 겹쳐 시각화를 할 수도 있고, `geom_rug()`와 결합하여 빈도가 높은 곳을 시각적으로 강조할 수도 있다. 마지막으로 

```{r gghighlight-histogram}
orig_hist_g <- faithful %>% 
  ggplot(aes(x=eruptions)) +
    geom_histogram()

density_hist_g <- faithful %>% 
  ggplot(aes(x=eruptions)) +
    geom_histogram(binwidth = 0.1) +
    geom_density(aes(y=..count.. * 0.1 ))

rug_hist_g <- faithful %>% 
  ggplot(aes(x=eruptions)) +
    geom_histogram(binwidth = 0.1) +
    geom_density(aes(y= 0.1 * ..count..)) +
    geom_rug()

deco_hist_g <- faithful %>% 
  ggplot(aes(x=eruptions)) +
    geom_histogram(binwidth = 0.1, fill="skyblue") +
    geom_density(aes(y=0.1 * ..count..)) +
    geom_rug(colour="red") +
    labs(x="분출 시간(단위: 분)", y="빈도수",
         title="유명한 간헐철(Geyser) 데이터 분출시간") +
    theme_minimal(base_family = "NanumGothic") 

cowplot::plot_grid(orig_hist_g, density_hist_g, rug_hist_g, deco_hist_g)   
```


### 집단 비교 {#gghighlight-histogram-group}

집단간 분포 비교를 위해서 종전 히스토그램과 밀도그래프(density plot)외에 최근에 바이올린(violin) 그래프와 능선(ridge) 그래프도 많이 사용되고 있다.

```{r gghighlight-histogram-group}
library(ggridges)

iris_df <- iris %>% tbl_df()

hist_group_g <- iris_df %>% 
  ggplot(aes(x=Sepal.Width, fill=Species)) +
    geom_histogram()  +
    labs(title="종별 히스토그램") +
    theme(legend.position = "top")

density_group_g <- iris_df %>% 
  ggplot(aes(x=Sepal.Width, fill=Species)) +
    geom_density(alpha=0.3) +
    labs(title="종별 밀도그래프") +
    theme(legend.position = "top")

boxplot_group_g <- iris_df %>% 
  ggplot(aes(y=Sepal.Width, fill=Species)) +
    geom_boxplot(alpha=0.3)   +
    labs(title="종별 상자그림")

violin_group_g <- iris_df %>% 
  ggplot(aes(y=Sepal.Width, x=Species)) +
    geom_violin(color = NA,
                fill = "lightseagreen",
                alpha = .5,
                na.rm = TRUE,
                scale = "count") +
    labs(title="종별 바이올린 그래프")

violin_boxplot_group_g <- iris_df %>% 
  ggplot(aes(y=Sepal.Width, x=Species)) +
    geom_violin(color = NA,
                fill = "lightseagreen",
                alpha = .5,
                na.rm = TRUE,
                scale = "count") +
    geom_boxplot(outlier.size = 2, 
                 colour = "lightseagreen",
                 fill = "black",
                 na.rm = TRUE,
                 width = .1) +
    labs(title="종별 바이올린 + 상자그림")


ridge_group_g <- iris_df %>% 
  ggplot(aes(x=`Sepal.Width`, y=Species)) +
    geom_density_ridges(scale = 1.1, 
                        fill = "lightseagreen", 
                        alpha=0.3)   +
    labs(title="종별 능선그래프")

raincloud_group_g <- iris_df %>% 
  ggplot(aes(x=`Sepal.Width`, y=Species)) +
    geom_density_ridges(jittered_points = TRUE, 
                        position = "raincloud",
                        scale = 0.7, 
                        fill = "lightseagreen", 
                        alpha=0.3)    +
    labs(title="종별 능선 + 강우그래프")
  
cowplot::plot_grid(hist_group_g, density_group_g,
                   violin_group_g, violin_boxplot_group_g,
                   ridge_group_g, raincloud_group_g)
```


### 집단 비교 - 벌꿀무리 {#gghighlight-histogram-beeswarm}

과거 `stripchart`를 사용해서 각 개별 관측점을 집단별로 비교하는 시각화를 많이 사용했는데 최근 `geom_beeswarm()`을 사용해서 이를 대체하고 있다.

1. `geom_jitter()` + `stat_summary()`을 조합시키면 `stripchart` 기능을 `ggplot`에서 구현시킬 수 있다.
1. 점그림(`dotplot`)은 `beeswarm` 그래프와 동일하지는 않지만 유사한 기능을 구현할 수 있다.
1. [`ggbeeswarm`](https://github.com/eclarke/ggbeeswarm)은 관측점을 점으로 찍어 직관적으로 집단간 비교도 수월하게 시각적한다.

```{r gghighlight-histogram-beeswarm}
library(ggbeeswarm)

# Stripchart
strip_g <- iris_df %>% 
  ggplot(aes(x = Species, y = Sepal.Width)) +
  geom_jitter(position = position_jitter(height = 0, width = .1), 
              fill = "lightseagreen", 
              colour = "lightseagreen",
              alpha = .5) + 
  stat_summary(fun.y = median, 
               fun.ymin = median, 
               fun.ymax = median, 
               geom = "crossbar", 
               width = 0.5) +
  coord_cartesian(ylim = c(2, 4.5)) +
  labs(x="", y="", title="스트립차트(stripchart)")

# dotplot
dotplot_g <- iris_df %>% 
  ggplot(aes(x = Species, y = Sepal.Width)) +
    geom_dotplot(stackdir = "center", 
                 binaxis = "y", 
                 binwidth = .1,
                 binpositions = "all",
                 stackratio = 1.5, 
                 fill = "lightseagreen", 
                 colour = "lightseagreen") +
    coord_cartesian(ylim = c(2, 4.5)) +
    labs(x="", y="", title="점그래프(Dot plot)")

# beeswarm
beeswarm_g <- iris_df %>% 
  ggplot(aes(x = Species, y = Sepal.Width)) +
    geom_quasirandom(fill = "lightseagreen", 
                     colour = "lightseagreen") +
    coord_cartesian(ylim = c(2, 4.5)) +
    labs(x="", y="", title="벌꿀무리 그래프")

# 상자그림 + 점그림
boxplot_dotplot_g <- iris_df %>% 
  ggplot(aes(x = Species, y = Sepal.Width)) +
    geom_boxplot(outlier.shape = NA) + 
    geom_jitter(fill = "lightseagreen", 
                colour = "lightseagreen",
                na.rm = TRUE,
                position = position_jitter(height = 0, width = .1),
                alpha = .5) + 
    coord_cartesian(ylim = c(2, 4.5)) +
    labs(x="", y="", title="상자그림 + 점그림")

cowplot::plot_grid(strip_g, dotplot_g,
                   beeswarm_g, boxplot_dotplot_g)

```